D<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - MovieStore</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="styles.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-film"></i> MovieStore
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="catalog.html">Catalog</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="cart.html">
                            <i class="fas fa-shopping-cart"></i> Cart <span id="cart-count" class="badge bg-primary">0</span>
                        </a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="login.html">Login</a>
                    </li>
                    <li class="nav-item">
                        <a class="btn btn-outline-light" href="login.html">Sign Up</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <section class="py-5">
        <div class="container">
            <div class="row">
                <div class="col-lg-8">
                    <h2 class="mb-4">Checkout</h2>

                    <!-- Order Summary -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">Order Summary</h5>
                        </div>
                        <div class="card-body">
                            <div id="checkout-items">
                                <!-- Items will be loaded here -->
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between">
                                <strong>Total:</strong>
                                <strong id="checkout-total">$0.00</strong>
                            </div>
                        </div>
                    </div>

                    <!-- Billing Information -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">Billing Information</h5>
                        </div>
                        <div class="card-body">
                            <form id="billing-form">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="first-name" class="form-label">First Name</label>
                                        <input type="text" class="form-control" id="first-name" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="last-name" class="form-label">Last Name</label>
                                        <input type="text" class="form-control" id="last-name" required>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="email" class="form-label">Email Address</label>
                                    <input type="email" class="form-control" id="billing-email" required>
                                </div>
                                <div class="mb-3">
                                    <label for="address" class="form-label">Address</label>
                                    <input type="text" class="form-control" id="address" required>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="city" class="form-label">City</label>
                                        <input type="text" class="form-control" id="city" required>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label for="state" class="form-label">State</label>
                                        <input type="text" class="form-control" id="state" required>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label for="zip" class="form-label">kode pos</label>
                                        <input type="text" class="form-control" id="zip" required>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Payment Information -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">Payment Information</h5>
                        </div>
                        <div class="card-body">
                            <form id="payment-form">
                                <div class="mb-3">
                                    <label class="form-label">Payment Method</label>
                                    <div class="row">
                                        <div class="col-md-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="payment-method" id="bank" value="bank" checked>
                                                <label class="form-check-label" for="bank">
                                                    <i class="fas fa-university"></i> Bank Transfer
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="payment-method" id="e-wallet" value="e-wallet">
                                                <label class="form-check-label" for="e-wallet">
                                                    <i class="fas fa-mobile-alt"></i> E-Wallet
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="payment-method" id="transfer" value="transfer">
                                                <label class="form-check-label" for="transfer">
                                                    <i class="fas fa-exchange-alt"></i> Transfer
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="payment-method" id="qris" value="qris">
                                                <label class="form-check-label" for="qris">
                                                    <i class="fas fa-qrcode"></i> QRIS
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div id="bank-details" style="display: block;">
                                    <div class="alert alert-info">
                                        <i class="fas fa-university"></i> <strong>Bank Transfer Instructions:</strong>
                                        <br>• Transfer to: BCA 1234567890 a/n MovieStore
                                        <br>• Amount: <strong id="bank-amount">$0.00</strong>
                                        <br>• Include order reference in transfer notes
                                        <br>• Processing time: 1-3 business days
                                    </div>
                                </div>

                                <div id="e-wallet-details" style="display: none;">
                                    <div class="mb-3">
                                        <label class="form-label">Select E-Wallet Provider</label>
                                        <select class="form-select" id="e-wallet-provider" required>
                                            <option value="">Choose provider...</option>
                                            <option value="ovo">OVO</option>
                                            <option value="gopay">GoPay</option>
                                            <option value="dana">DANA</option>
                                            <option value="linkaja">LinkAja</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="e-wallet-number" class="form-label">E-Wallet Number</label>
                                        <input type="text" class="form-control" id="e-wallet-number" placeholder="08xxxxxxxxx" required>
                                    </div>
                                    <div class="alert alert-info">
                                        <i class="fas fa-mobile-alt"></i> You will receive a payment confirmation via SMS.
                                    </div>
                                </div>

                                <div id="transfer-details" style="display: none;">
                                    <div class="mb-3">
                                        <label class="form-label">Select Bank for Transfer</label>
                                        <select class="form-select" id="transfer-bank">
                                            <option value="">Choose bank...</option>
                                            <option value="bca">BCA</option>
                                            <option value="mandiri">Mandiri</option>
                                            <option value="bni">BNI</option>
                                            <option value="bri">BRI</option>
                                            <option value="cimb">CIMB Niaga</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="transfer-account" class="form-label">Your Account Number</label>
                                        <input type="text" class="form-control" id="transfer-account" placeholder="Account number">
                                    </div>
                                    <div class="alert alert-info">
                                        <i class="fas fa-exchange-alt"></i> Transfer will be processed instantly.
                                    </div>
                                </div>

                                <div id="qris-details" style="display: none;">
                                    <div class="text-center mb-3">
                                        <div class="qr-placeholder bg-light p-4 rounded">
                                            <i class="fas fa-qrcode fa-4x text-secondary mb-3"></i>
                                            <p class="mb-0">QR Code will be generated after order confirmation</p>
                                        </div>
                                    </div>
                                    <div class="alert alert-success">
                                        <i class="fas fa-qrcode"></i> <strong>QRIS Payment:</strong>
                                        <br>• Scan QR code with any e-wallet app
                                        <br>• Instant payment confirmation
                                        <br>• Supported by all major e-wallet providers
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4">
                    <div class="card sticky-top">
                        <div class="card-body">
                            <h5 class="card-title">Order Summary</h5>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Subtotal:</span>
                                <span id="summary-subtotal">$0.00</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Tax:</span>
                                <span id="summary-tax">$0.00</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Shipping:</span>
                                <span id="summary-shipping">Free</span>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between mb-3">
                                <strong>Total:</strong>
                                <strong id="summary-total">$0.00</strong>
                            </div>
                            <button class="btn checkout-btn w-100" onclick="processPayment()">
                                <i class="fas fa-lock"></i> Complete Order
                            </button>
                            <p class="text-muted small mt-2 mb-0">
                                <i class="fas fa-shield-alt"></i> Secure checkout with SSL encryption
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Confirmation Modal -->
    <div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmationModalLabel">Confirm Your Purchase</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h6>Order Summary:</h6>
                    <div id="modal-order-summary">
                        <!-- Order summary will be populated here -->
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between">
                        <strong>Total:</strong>
                        <strong id="modal-total">$0.00</strong>
                    </div>
                    <p class="mt-3 text-muted">By confirming, you agree to proceed with the selected payment method.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirm-purchase-btn">Confirm Purchase</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Photo Upload Modal for Transfer Proof -->
    <div class="modal fade" id="photoUploadModal" tabindex="-1" aria-labelledby="photoUploadModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Please upload a photo of your transfer proof to complete the payment.</p>
                    <div class="mb-3">
                        <label for="transfer-proof" class="form-label">Select Photo</label>
                        <input type="file" class="form-control" id="transfer-proof" accept="image/*" required>
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> Supported formats: JPG, PNG, GIF. Max size: 5MB.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="upload-proof-btn">Upload & Complete Order</button>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-dark text-white py-4">
        <div class="container text-center">
            <p>&copy; 2025 MovieStore. All rights reserved.</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="data.js"></script>
    <script src="app.js"></script>
    <script>
        // Load checkout items
        function loadCheckoutItems() {
            const checkoutItems = document.getElementById('checkout-items');
            const checkoutTotal = document.getElementById('checkout-total');
            const summarySubtotal = document.getElementById('summary-subtotal');
            const summaryTax = document.getElementById('summary-tax');
            const summaryTotal = document.getElementById('summary-total');

            checkoutItems.innerHTML = '';
            let total = 0;

            cart.forEach((item, index) => {
                total += item.price * item.quantity;
                checkoutItems.innerHTML += `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <strong>${item.title}</strong>
                            <br>
                            <small class="text-muted">${item.type === 'purchase' ? 'Purchase' : 'Rental'} - Quantity: ${item.quantity}</small>
                        </div>
                        <span>$${(item.price * item.quantity).toFixed(2)}</span>
                    </div>
                `;
            });

            const tax = total * 0.08; // 8% tax
            const finalTotal = total + tax;

            checkoutTotal.textContent = `$${finalTotal.toFixed(2)}`;
            summarySubtotal.textContent = `$${total.toFixed(2)}`;
            summaryTax.textContent = `$${tax.toFixed(2)}`;
            summaryTotal.textContent = `$${finalTotal.toFixed(2)}`;
        }

        // Payment method switching
        document.querySelectorAll('input[name="payment-method"]').forEach(radio => {
            radio.addEventListener('change', function() {
                // Hide all payment details
                const allDetails = ['bank-details', 'e-wallet-details', 'transfer-details', 'qris-details'];
                allDetails.forEach(id => {
                    document.getElementById(id).style.display = 'none';
                });

                // Show selected payment details
                const selectedDetails = this.value + '-details';
                document.getElementById(selectedDetails).style.display = 'block';

                // Update bank amount if bank transfer is selected
                if (this.value === 'bank') {
                    updateBankAmount();
                }
            });
        });

        // Update bank transfer amount
        function updateBankAmount() {
            const total = document.getElementById('summary-total').textContent;
            document.getElementById('bank-amount').textContent = total;
        }

        // Process payment
        function processPayment() {
            // Validate forms
            const billingForm = document.getElementById('billing-form');

            if (!billingForm.checkValidity()) {
                billingForm.reportValidity();
                return;
            }

            const paymentMethod = document.querySelector('input[name="payment-method"]:checked').value;

            // Validate payment method specific fields
            if (paymentMethod === 'e-wallet') {
                const eWalletProvider = document.getElementById('e-wallet-provider');
                const eWalletNumber = document.getElementById('e-wallet-number');
                if (!eWalletProvider.value || !eWalletNumber.value) {
                    showNotification('Please fill in all e-wallet details.', 'warning');
                    return;
                }
            } else if (paymentMethod === 'transfer') {
                // Transfer doesn't require validation for now
            } else if (paymentMethod === 'qris') {
                // QRIS doesn't require additional validation
            }

            // Populate confirmation modal with order summary
            populateConfirmationModal();

            // Show confirmation modal
            const confirmationModal = new bootstrap.Modal(document.getElementById('confirmationModal'));
            confirmationModal.show();
        }

        // Populate confirmation modal with order summary
        function populateConfirmationModal() {
            const modalOrderSummary = document.getElementById('modal-order-summary');
            const modalTotal = document.getElementById('modal-total');

            modalOrderSummary.innerHTML = '';
            cart.forEach((item) => {
                modalOrderSummary.innerHTML += `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <strong>${item.title}</strong>
                            <br>
                            <small class="text-muted">${item.type === 'purchase' ? 'Purchase' : 'Rental'} - Quantity: ${item.quantity}</small>
                        </div>
                        <span>$${(item.price * item.quantity).toFixed(2)}</span>
                    </div>
                `;
            });

            modalTotal.textContent = document.getElementById('summary-total').textContent;
        }

        // Handle confirmation modal confirm button
        document.getElementById('confirm-purchase-btn').addEventListener('click', function() {
            const paymentMethod = document.querySelector('input[name="payment-method"]:checked').value;

            // Close confirmation modal
            const confirmationModal = bootstrap.Modal.getInstance(document.getElementById('confirmationModal'));
            confirmationModal.hide();

            if (paymentMethod === 'bank' || paymentMethod === 'transfer') {
                // Show photo upload modal for bank transfer or transfer
                const photoModal = new bootstrap.Modal(document.getElementById('photoUploadModal'));
                photoModal.show();
            } else if (paymentMethod === 'e-wallet') {
                // Simulate e-wallet redirect
                simulateEWalletRedirect();
            } else {
                // For qris, proceed directly
                completeOrder();
            }
        });

        // Simulate e-wallet redirect
        function simulateEWalletRedirect() {
            showNotification('Redirecting to e-wallet application...', 'info');
            setTimeout(() => {
                // Simulate successful payment after redirect
                showNotification('Payment completed via e-wallet!', 'success');
                completeOrder();
            }, 3000);
        }

        // Complete order (save to cloud, clear cart, redirect)
        function completeOrder() {
            // Save order to cloud storage (simulated)
            const savedOrder = saveOrderToCloud();

            // Update transfer proof with order ID if it exists
            if (savedOrder && savedOrder.id) {
                updateTransferProofOrderId(savedOrder.id);
            }

            showNotification('Order placed successfully!', 'success');

            // Clear cart
            cart = [];
            localStorage.setItem('cart', JSON.stringify(cart));
            updateCartCount();

            // Redirect to success page
            setTimeout(() => {
                window.location.href = 'order-success.html';
            }, 2000);
        }

        // Update transfer proof with order ID
        function updateTransferProofOrderId(orderId) {
            const stored = localStorage.getItem('cloudStorage');
            if (stored) {
                const cloudData = JSON.parse(stored);
                if (cloudData.transferProofs && cloudData.transferProofs.length > 0) {
                    // Find the most recent transfer proof without orderId
                    const recentProof = cloudData.transferProofs
                        .filter(proof => !proof.orderId)
                        .sort((a, b) => new Date(b.uploadedAt) - new Date(a.uploadedAt))[0];

                    if (recentProof) {
                        recentProof.orderId = orderId;
                        localStorage.setItem('cloudStorage', JSON.stringify(cloudData));
                        console.log('Transfer proof updated with order ID:', orderId);
                    }
                }
            }
        }

        // Handle photo upload modal submit
        document.getElementById('upload-proof-btn').addEventListener('click', function() {
            const fileInput = document.getElementById('transfer-proof');
            const file = fileInput.files[0];

            if (!file) {
                showNotification('Please select a photo to upload.', 'warning');
                return;
            }

            // Validate file type
            const allowedTypes = ['image/jpeg', 'image/png', 'image/gif'];
            if (!allowedTypes.includes(file.type)) {
                showNotification('Please select a valid image file (JPG, PNG, GIF).', 'error');
                return;
            }

            // Validate file size (5MB max)
            const maxSize = 5 * 1024 * 1024; // 5MB
            if (file.size > maxSize) {
                showNotification('File size must be less than 5MB.', 'error');
                return;
            }

            // Close photo upload modal
            const photoModal = bootstrap.Modal.getInstance(document.getElementById('photoUploadModal'));
            photoModal.hide();

            // Convert file to base64 and save to cloud storage
            const reader = new FileReader();
            reader.onload = function(e) {
                const base64Data = e.target.result;
                const transferProof = {
                    id: Date.now(),
                    fileName: file.name,
                    fileType: file.type,
                    fileSize: file.size,
                    data: base64Data,
                    uploadedAt: new Date().toISOString(),
                    orderId: null // Will be set when order is completed
                };

                // Save to cloud storage
                saveTransferProof(transferProof);

                showNotification('Uploading transfer proof...', 'info');
                setTimeout(() => {
                    showNotification('Transfer proof uploaded successfully!', 'success');
                    completeOrder();
                }, 2000);
            };
            reader.readAsDataURL(file);
        });

        // Save order to cloud (simulated)
        function saveOrderToCloud() {
            const orderData = {
                id: Date.now(),
                userId: currentUser ? currentUser.id : null,
                items: cart,
                billingInfo: {
                    firstName: document.getElementById('first-name').value,
                    lastName: document.getElementById('last-name').value,
                    email: document.getElementById('billing-email').value,
                    address: document.getElementById('address').value,
                    city: document.getElementById('city').value,
                    state: document.getElementById('state').value,
                    zip: document.getElementById('zip').value
                },
                paymentMethod: document.querySelector('input[name="payment-method"]:checked').value,
                total: parseFloat(document.getElementById('summary-total').textContent.replace('$', '')),
                date: new Date().toISOString()
            };

            // Save payment method if user wants to save it (only for card payments)
            const savePayment = document.getElementById('save-payment') && document.getElementById('save-payment').checked;
            if (savePayment && currentUser && paymentMethod === 'credit-card') {
                const paymentMethodData = {
                    type: paymentMethod,
                    cardNumber: document.getElementById('card-number').value.slice(-4), // Only last 4 digits
                    expiryDate: document.getElementById('expiry-date').value,
                    cardName: document.getElementById('card-name').value
                };
                savePaymentMethod(currentUser.id, paymentMethodData);
            }

            // Save order using cloud storage function
            saveOrder(orderData);

            console.log('Order saved to cloud:', orderData);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            if (cart.length === 0) {
                window.location.href = 'cart.html';
                return;
            }

            loadCheckoutItems();
            updateBankAmount(); // Initialize bank amount
        });
    </script>
</body>
</html>
